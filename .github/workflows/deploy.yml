name: Deploy to Linux Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Pull latest code
        run: |
          cd /home/kishanvyas/projects/Import-Export
          git pull origin main
          cd ./Frontend
          npm install
          cd ../Backend
          npm install

      - name: Restart PM2 apps
        run: |
          pm2 restart 1
          pm2 restart 5
          
      - name: Run NPM Audit (Security)
        run: |
          npm audit --production || true  # Prevents pipeline failure

      - name: Send Telegram Notification on Success
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text=$'âœ… *Deployment Successful!*\n\n*ğŸ” Branch:* `main`\nğŸ›  *Project:* Import-Export\nğŸš€ *Status:* Code Pulled & PM2 Restarted\nğŸ§‘â€ğŸ’» *Triggered by:* GitHub Actions\n\nğŸ•’ Time: '"$(date '+%d %b %Y, %I:%M %p')"'\n\nğŸŸ¢ Everything looks good!'
      - name: Send Telegram Notification on Failure
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text=$'âŒ *Deployment Failed!*\n\n*ğŸ” Branch:* `main`\nğŸ›  *Project:* Import-Export\nğŸ’£ *Status:* CI/CD Failed!\n\nğŸ“„ *Check logs:* [GitHub Actions](https://github.com/KishanVyas308/Import-Export/actions)\n\nğŸ•’ Time: '"$(date '+%d %b %Y, %I:%M %p')"'\n\nğŸ”´ Please investigate immediately!'

